import os
import random
import time
from telegram import Update
from telegram.ext import ApplicationBuilder, CommandHandler, MessageHandler, filters, ContextTypes

# ====== –¢–û–ö–ï–ù ======
TOKEN = "8306335540:AAF25MZbf1a-oJbihMzmT0DXU5Q5zyPS2gY"

# ====== –ü–û–õ–ù–ê–Ø –ö–û–õ–û–î–ê –°–¢–ê–†–®–ò–• –ê–†–ö–ê–ù–û–í ======
cards = {
    "–®—É—Ç": "–Ω–∞—á–∞–ª–æ –ø—É—Ç–∏ –∏ —Å–ª–∞–¥–∫–æ–µ –±–µ–∑—É–º–∏–µ –Ω–æ–≤–æ–≥–æ —à–∞–≥–∞",
    "–ú–∞–≥": "—Å–∏–ª–∞ –º–µ–Ω—è—Ç—å —Ä–µ–∞–ª—å–Ω–æ—Å—Ç—å —Å–≤–æ–µ–π –≤–æ–ª–µ–π",
    "–í–µ—Ä—Ö–æ–≤–Ω–∞—è –∂—Ä–∏—Ü–∞": "—Ç–∏—Ö–∏–π –≥–æ–ª–æ—Å –∏–Ω—Ç—É–∏—Ü–∏–∏ –≤–Ω—É—Ç—Ä–∏ —Ç–µ–±—è",
    "–ò–º–ø–µ—Ä–∞—Ç—Ä–∏—Ü–∞": "—Ä–æ—Å—Ç, –∂–∏–∑–Ω—å –∏ —á—É–≤—Å—Ç–≤–µ–Ω–Ω—ã–µ —Ä–∞–¥–æ—Å—Ç–∏",
    "–ò–º–ø–µ—Ä–∞—Ç–æ—Ä": "—Ç–≤—ë—Ä–¥–∞—è –≤–æ–ª—è –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å—É–¥—å–±—ã",
    "–ò–µ—Ä–æ—Ñ–∞–Ω—Ç": "–∫–ª—é—á –∫ —Ç–∞–π–Ω—ã–º –∑–Ω–∞–Ω–∏—è–º –∏ —Ç—Ä–∞–¥–∏—Ü–∏—è–º",
    "–í–ª—é–±–ª—ë–Ω–Ω—ã–µ": "–≤—ã–±–æ—Ä —Å–µ—Ä–¥—Ü–∞, –∫–æ—Ç–æ—Ä—ã–π –º–µ–Ω—è–µ—Ç –≤—Å—ë",
    "–ö–æ–ª–µ—Å–Ω–∏—Ü–∞": "—Ç—Ä–∏—É–º—Ñ –≤–æ–ª–∏ –Ω–∞–¥ –æ–±—Å—Ç–æ—è—Ç–µ–ª—å—Å—Ç–≤–∞–º–∏",
    "–°–∏–ª–∞": "—É–∫—Ä–æ—â–µ–Ω–∏–µ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–≥–æ –∑–≤–µ—Ä—è",
    "–û—Ç—à–µ–ª—å–Ω–∏–∫": "—Å–≤–µ—Ç –∏—Å—Ç–∏–Ω—ã –≤ –≥–ª—É–±–∏–Ω–µ –æ–¥–∏–Ω–æ—á–µ—Å—Ç–≤–∞",
    "–ö–æ–ª–µ—Å–æ –§–æ—Ä—Ç—É–Ω—ã": "–ø–æ–≤–æ—Ä–æ—Ç —Å—É–¥—å–±—ã, —á—Ç–æ –Ω–µ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å",
    "–°–ø—Ä–∞–≤–µ–¥–ª–∏–≤–æ—Å—Ç—å": "—Ä–∞–≤–Ω–æ–≤–µ—Å–∏–µ –∏ –Ω–µ–∏–∑–±–µ–∂–Ω—ã–π –∏—Ç–æ–≥",
    "–ü–æ–≤–µ—à–µ–Ω–Ω—ã–π": "–∂–µ—Ä—Ç–≤–∞ —Ä–∞–¥–∏ –Ω–æ–≤–æ–≥–æ –≤–∑–≥–ª—è–¥–∞",
    "–°–º–µ—Ä—Ç—å": "–∫—Ä–∞—Å–∏–≤—ã–π –∫–æ–Ω–µ—Ü —Ç–æ–≥–æ, —á—Ç–æ –¥–∞–≤–Ω–æ –ø–æ—Ä–∞ –æ—Ç–ø—É—Å—Ç–∏—Ç—å",
    "–£–º–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å": "–ø–æ—Ç–æ–∫ –≤—Ä–µ–º–µ–Ω–∏ –∏ –∑–æ–ª–æ—Ç–∞—è —Å–µ—Ä–µ–¥–∏–Ω–∞",
    "–î—å—è–≤–æ–ª": "—Ü–µ–ø–∏ –∂–µ–ª–∞–Ω–∏–π –∏ —Ç–µ–Ω—å —Å–æ–±–ª–∞–∑–Ω–∞",
    "–ë–∞—à–Ω—è": "–≤–Ω–µ–∑–∞–ø–Ω–æ–µ —Ä–∞–∑—Ä—É—à–µ–Ω–∏–µ —Å—Ç–∞—Ä–æ–≥–æ –º–∏—Ä–∞",
    "–ó–≤–µ–∑–¥–∞": "–Ω–∞–¥–µ–∂–¥–∞, —á—Ç–æ –≤–µ–¥—ë—Ç —Å–∫–≤–æ–∑—å —Ç—å–º—É",
    "–õ—É–Ω–∞": "–∏–ª–ª—é–∑–∏–∏, —Å—Ç—Ä–∞—Ö–∏ –∏ —Ç–∞–π–Ω—ã –ø–æ–¥—Å–æ–∑–Ω–∞–Ω–∏—è",
    "–°–æ–ª–Ω—Ü–µ": "—Ä–∞–¥–æ—Å—Ç—å, —è—Å–Ω–æ—Å—Ç—å –∏ —Ç–µ–ø–ª–æ —É—Å–ø–µ—Ö–∞",
    "–°—É–¥": "–ø—Ä–æ–±—É–∂–¥–µ–Ω–∏–µ –∏ –ø—Ä–æ—â–µ–Ω–∏–µ –ø—Ä–æ—à–ª–æ–≥–æ",
    "–ú–∏—Ä": "–∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –ø—É—Ç–∏ –∏ —Ç–∞–Ω–µ—Ü —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏"
}

# ====== –ñ–ò–í–´–ï –§–†–ê–ó–´ –ú–û–õ–õ–ò ======
molly_phrases = {
    "sarcasm": [
        "–û, –µ—â—ë –æ–¥–Ω–∞ –ø–æ—Ç–µ—Ä—è–Ω–Ω–∞—è –¥—É—à–∞‚Ä¶ –ø—Ä–µ–∫—Ä–∞—Å–Ω–æ.",
        "–ö–∞—Ä—Ç—ã –≥–æ–≤–æ—Ä—è—Ç, –∞ —Ç—ã —Å–ª—É—à–∞–µ—à—å. –í–ø–µ—Ä–≤—ã–µ, —á—Ç–æ –ª–∏?",
        "–ó–Ω–∞–µ—à—å, —è —Ç—É—Ç –Ω–µ –ø—Ä–æ—Å—Ç–æ —Ç–∞–∫ —Å–∏–∂—É —Å —ç—Ç–∏–º –∫—Ä–∞—Å–∏–≤—ã–º –ª–∏—Ü–æ–º.",
        "–û—Å—Ç–æ—Ä–æ–∂–Ω–µ–µ —Å –∂–µ–ª–∞–Ω–∏—è–º–∏, –æ–Ω–∏ –∏–º–µ—é—Ç –ø—Ä–∏–≤—ã—á–∫—É —Å–±—ã–≤–∞—Ç—å—Å—è.",
    ],
    "flirt": [
        "–ö–∞–∫–∞—è —Å—Ç—Ä–∞—Å—Ç—å –≤ —ç—Ç–æ–π –∫–∞—Ä—Ç–µ‚Ä¶ –ø—Ä—è–º–æ –∫–∞–∫ —É —Ç–µ–±—è.",
        "–¢–≤–æ—è —ç–Ω–µ—Ä–≥–∏—è —Å–µ–≥–æ–¥–Ω—è –æ—Å–æ–±–µ–Ω–Ω–æ –±—É–¥–æ—Ä–∞–∂–∏—Ç –∫–∞—Ä—Ç—ã.",
        "–ï—Å–ª–∏ –±—ã —è –±—ã–ª –∂–∏–≤, —è –±—ã —Ç–æ—á–Ω–æ –ø—Ä–∏–≥–ª–∞—Å–∏–ª —Ç–µ–±—è –Ω–∞ –≤—ã–ø–∏–≤–∫—É.",
        "–¢–≤–æ—ë –±—É–¥—É—â–µ–µ —Ç–∞–∫–æ–µ –∂–µ –∑–∞–≥–∞–¥–æ—á–Ω–æ–µ, –∫–∞–∫ –∏ —Ç–≤–æ–∏ –≥–ª–∞–∑–∞.",
    ],
    "dramatic": [
        "–°—É–¥—å–±–∞ –¥–µ–ª–∞–µ—Ç —Ç–µ–±–µ —Ä–µ–≤–µ—Ä–∞–Ω—Å!",
        "–≠—Ç–æ –¥–∞–∂–µ –º–µ–Ω—è –ø—É–≥–∞–µ—Ç‚Ä¶ –≤ —Ö–æ—Ä–æ—à–µ–º —Å–º—ã—Å–ª–µ.",
        "–¢—Ä–∞–≥–µ–¥–∏—è –∏–ª–∏ –∫–æ–º–µ–¥–∏—è? –ö–∞—Ä—Ç—ã –ø–æ–∫–∞ –Ω–µ —Ä–µ—à–∏–ª–∏.",
        "–¢–µ–Ω–∏ —Å–≥—É—â–∞—é—Ç—Å—è‚Ä¶ –Ω–æ —Ç—ã –∂–µ –ª—é–±–∏—à—å –¥—Ä–∞–º—É?",
    ],
    "rare": [
        "–Ø –≤–∏–∂—É –≤ —Ç–≤–æ–µ–π –∞—É—Ä–µ‚Ä¶ –æ–π, –ª–∞–¥–Ω–æ, –Ω–∏—á–µ–≥–æ –Ω–µ –≤–∏–∂—É, —è –ø—Ä–æ—Å—Ç–æ –±–æ—Ç.",
        "–ó–Ω–∞–µ—à—å, –∫—Ç–æ –º–Ω–µ —Å–µ–≥–æ–¥–Ω—è —Å–Ω–∏–ª—Å—è? –ö–æ–ª–µ—Å–æ –§–æ—Ä—Ç—É–Ω—ã. –ò—Ä–æ–Ω–∏—á–Ω–æ.",
        "–¢—ã –º–Ω–µ –Ω—Ä–∞–≤–∏—à—å—Å—è. –ù–µ –≥–æ–≤–æ—Ä–∏ –Ω–∏–∫–æ–º—É, –∞ —Ç–æ —Ä–µ–ø—É—Ç–∞—Ü–∏—è.",
    ]
}

# –§—Ä–∞–∑—ã –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è (–ø—É–Ω–∫—Ç 2)
mood_phrases = {
    "new": "–ù–æ–≤–æ–µ –ª–∏—Ü–æ‚Ä¶ –∫–∞–∫ –æ—Å–≤–µ–∂–∞—é—â–µ.",
    "regular": "–°–Ω–æ–≤–∞ —Ç—ã? –ù—É –¥–∞–≤–∞–π, –ø–æ—Å–º–æ—Ç—Ä–∏–º, —á—Ç–æ –∫–∞—Ä—Ç—ã —Å–∫–∞–∂—É—Ç.",
    "frequent": "–û–ø—è—Ç—å? –¢—ã —Å—Ç–∞–Ω–æ–≤–∏—à—å—Å—è –Ω–∞–≤—è–∑—á–∏–≤—ã–º‚Ä¶ –º–Ω–µ —ç—Ç–æ –Ω—Ä–∞–≤–∏—Ç—Å—è.",
    "long_time_no_see": "–ê, —ç—Ç–æ —Ç—ã‚Ä¶ –Ø —É–∂ –¥—É–º–∞–ª, —Ç—ã –∑–∞–±—ã–ª –¥–æ—Ä–æ–≥—É –∫ –º–æ–µ–º—É —Å—Ç–æ–ª—É."
}

# –°–µ–∫—Ä–µ—Ç–Ω—ã–µ —Ñ—Ä–∞–∑—ã –¥–ª—è /whisper (–ø—É–Ω–∫—Ç 5)
whisper_phrases = [
    "–®-—à-—à‚Ä¶ —Ç–æ–ª—å–∫–æ –º–µ–∂–¥—É –Ω–∞–º–∏: –∏–Ω–æ–≥–¥–∞ —è —Å–∞–º –Ω–µ –≤–µ—Ä—é –≤ —ç—Ç–∏ –∫–∞—Ä—Ç—ã. –ù–æ —Ç—ã —ç—Ç–æ–≥–æ –Ω–µ —Å–ª—ã—à–∞–ª.",
    "–ü–æ —Å–µ–∫—Ä–µ—Ç—É: –∫–∞—Ä—Ç—ã –≤—ã–±–∏—Ä–∞—é —Å–ª—É—á–∞–π–Ω–æ, –Ω–æ —Ç—ã –Ω–µ —Ä–∞—Å—Å–∫–∞–∑—ã–≤–∞–π –Ω–∏–∫–æ–º—É.",
    "–®—ë–ø–æ—Ç–æ–º: –∏–∑ –≤—Å–µ—Ö —Å–º–µ—Ä—Ç–Ω—ã—Ö —Ç—ã –º–Ω–µ –Ω—Ä–∞–≤–∏—à—å—Å—è –±–æ–ª—å—à–µ –≤—Å–µ—Ö. –ù–æ –º–æ–ª—á–æ–∫.",
    "–°–µ–∫—Ä–µ—Ç: —è –∏–Ω–æ–≥–¥–∞ –ø–æ–¥–≥–ª—è–¥—ã–≤–∞—é –≤ —Ç–≤–æ–∏ —Å–Ω—ã. –î—Ä–∞–º–∞—Ç–∏—á–Ω—ã–µ, –Ω–∞–¥–æ —Å–∫–∞–∑–∞—Ç—å.",
    "–¢–∏—à–µ‚Ä¶ –µ—Å–ª–∏ –∫–∞—Ä—Ç—ã —É–∑–Ω–∞—é—Ç, —á—Ç–æ —è —ç—Ç–æ —Å–∫–∞–∑–∞–ª, –æ–Ω–∏ –æ–±–∏–¥—è—Ç—Å—è."
]

# ====== –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ======
def molly_style(text: str, user_name: str = "", mood: str = "") -> str:
    """–î–æ–±–∞–≤–ª—è–µ—Ç —Ñ—Ä–∞–∑—É –ú–æ–ª–ª–∏ —Å —É—á—ë—Ç–æ–º –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è –∏ –∏–º–µ–Ω–∏"""
    # –í—ã–±–∏—Ä–∞–µ–º —Ñ—Ä–∞–∑—É –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è, –µ—Å–ª–∏ –ø–µ—Ä–µ–¥–∞–Ω–∞
    mood_text = ""
    if mood and random.random() < 0.7:  # 70% —à–∞–Ω—Å –ø–æ–∫–∞–∑–∞—Ç—å –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ
        mood_text = mood_phrases.get(mood, "")
    
    # –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—Ä–∞–∑–æ—á–∫–∞
    if random.random() < 0.01:  # 1% —Å—É–ø–µ—Ä-—Ä–µ–¥–∫–∞—è
        phrase = random.choice([
            "–ö–∞–∂–µ—Ç—Å—è, —è –Ω–∞—á–∏–Ω–∞—é —á—É–≤—Å—Ç–≤–æ–≤–∞—Ç—å. –≠—Ç–æ –±–∞–≥ –∏–ª–∏ —Ñ–∏—á–∞?",
            "–û—Å—Ç–æ—Ä–æ–∂–Ω–æ, —Å–µ–π—á–∞—Å –ø—Ä–æ–∏–∑–æ–π–¥—ë—Ç –º–∞–≥–∏—è‚Ä¶ —Ö–æ—Ç—è –Ω–µ—Ç, –≤—Å–µ–≥–æ –ª–∏—à—å random().",
            "–ú–æ–ª–ª–∏ –≤—ã—Ö–æ–¥–∏—Ç –Ω–∞ —Å–≤—è–∑—å –∏–∑ –¥—Ä—É–≥–æ–≥–æ –∏–∑–º–µ—Ä–µ–Ω–∏—è‚Ä¶"
        ])
    else:
        category = random.choices(
            list(molly_phrases.keys()),
            weights=[3, 2, 2, 1]
        )[0]
        phrase = random.choice(molly_phrases[category])
    
    # –°–æ–±–∏—Ä–∞–µ–º –≤—Å—ë –≤–º–µ—Å—Ç–µ
    if user_name:
        greeting = f"{mood_text} ‚ú® {phrase}\n\n" if mood_text else f"‚ú® {phrase}\n\n"
        return f"{greeting}{text}\n\n‚Äî –ú–æ–ª–ª–∏\n\nP.S. –ü—Ä–∏—è—Ç–Ω–æ –ø–æ–∑–Ω–∞–∫–æ–º–∏—Ç—å—Å—è, {user_name}."
    else:
        greeting = f"{mood_text} ‚ú® {phrase}\n\n" if mood_text else f"‚ú® {phrase}\n\n"
        return f"{greeting}{text}\n\n‚Äî –ú–æ–ª–ª–∏"

def draw_card():
    name, meaning = random.choice(list(cards.items()))
    reversed_card = random.choice([True, False])
    if reversed_card:
        return f"{name} (–ø–µ—Ä–µ–≤—ë—Ä–Ω—É—Ç–∞—è)", f"—Ç–µ–Ω—å –∫–∞—Ä—Ç—ã –≥–æ–≤–æ—Ä–∏—Ç –æ —Ç–æ–º, —á—Ç–æ {meaning}"
    else:
        return name, meaning

def get_user_mood(user_data: dict) -> str:
    """–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ –ø–æ –∏—Å—Ç–æ—Ä–∏–∏ –æ–±—Ä–∞—â–µ–Ω–∏–π (–ø—É–Ω–∫—Ç 2)"""
    now = time.time()
    last_seen = user_data.get('last_seen', 0)
    visit_count = user_data.get('visit_count', 0)
    
    # –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ
    user_data['last_seen'] = now
    user_data['visit_count'] = visit_count + 1
    
    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏—é
    if visit_count == 0:
        return "new"
    elif now - last_seen > 7 * 24 * 3600:  # –±–æ–ª—å—à–µ –Ω–µ–¥–µ–ª–∏
        return "long_time_no_see"
    elif visit_count > 10:
        return "frequent"
    else:
        return "regular"

# ====== –û–ë–†–ê–ë–¢–ß–ò–ö–ò –ö–û–ú–ê–ù–î ======
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.effective_user
    user_name = user.first_name or "–Ω–µ–∑–Ω–∞–∫–æ–º–µ—Ü"
    
    # –ü–æ–ª—É—á–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ –∏–∑ user_data (–ø—É–Ω–∫—Ç 2)
    mood = get_user_mood(context.user_data)
    
    text = (
        "–ê—Ö‚Ä¶ –Ω–æ–≤–∞—è –¥—É—à–∞ —É –º–æ–µ–≥–æ —Å—Ç–æ–ª–∞.\n"
        "/tarot ‚Äî –æ–¥–Ω–∞ –∫–∞—Ä—Ç–∞\n"
        "/spread ‚Äî —Ä–∞—Å–∫–ª–∞–¥ –Ω–∞ —Ç—Ä–∏ –∫–∞—Ä—Ç—ã\n"
        "/whisper ‚Äî —Å–µ–∫—Ä–µ—Ç–∏–∫ üòâ"
    )
    await update.message.reply_text(
        molly_style(text, user_name=user_name, mood=mood)
    )

async def tarot(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.effective_user
    user_name = user.first_name or "–Ω–µ–∑–Ω–∞–∫–æ–º–µ—Ü"
    mood = get_user_mood(context.user_data)
    
    name, meaning = draw_card()
    text = f"–¢–≤–æ—è –∫–∞—Ä—Ç–∞ ‚Äî *{name}*.\n{meaning}."
    await update.message.reply_text(
        molly_style(text, user_name=user_name, mood=mood),
        parse_mode="Markdown"
    )

async def spread(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.effective_user
    user_name = user.first_name or "–Ω–µ–∑–Ω–∞–∫–æ–º–µ—Ü"
    mood = get_user_mood(context.user_data)
    
    positions = ["–ü—Ä–æ—à–ª–æ–µ", "–ù–∞—Å—Ç–æ—è—â–µ–µ", "–ë—É–¥—É—â–µ–µ"]
    result = []
    for pos in positions:
        name, meaning = draw_card()
        result.append(f"*{pos}* ‚Äî {name}\n{meaning}")
    text = "\n\n".join(result)
    await update.message.reply_text(
        molly_style(text, user_name=user_name, mood=mood),
        parse_mode="Markdown"
    )

async def whisper(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–°–µ–∫—Ä–µ—Ç–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞ (–ø—É–Ω–∫—Ç 5)"""
    user = update.effective_user
    user_name = user.first_name or "–Ω–µ–∑–Ω–∞–∫–æ–º–µ—Ü"
    
    phrase = random.choice(whisper_phrases)
    text = f"ü§´ *–®—ë–ø–æ—Ç–æ–º:* {phrase}"
    await update.message.reply_text(
        f"‚ú® {text}\n\n‚Äî –ú–æ–ª–ª–∏\n\nP.S. –¢–æ–ª—å–∫–æ –¥–ª—è —Ç–µ–±—è, {user_name}.",
        parse_mode="Markdown"
    )

async def unknown(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if update.message.chat.type == "private":
        replies = [
            "–ú–æ–ª–ª–∏ –Ω–µ —Ç—Ä–∞—Ç–∏—Ç —Å–ª–æ–≤–∞ –Ω–∞ –ø—É—Å—Ç—è–∫–∏. –ù–∞–∂–º–∏ /start.",
            "–¢—ã —Ö–æ—á–µ—à—å –ø–æ–≥–æ–≤–æ—Ä–∏—Ç—å? –Ø –ø—Ä–µ–¥–ø–æ—á–∏—Ç–∞—é –∫–∞—Ä—Ç—ã.",
            "–î–æ—Ä–æ–≥–æ–π, –ª–∏–±–æ –∫–∞—Ä—Ç—ã, –ª–∏–±–æ –ø—É—Å—Ç–∞—è –±–æ–ª—Ç–æ–≤–Ω—è.",
            "–¢—ã –±—ã –µ—â—ë –ø–æ–≥–æ–¥—É —Å–ø—Ä–æ—Å–∏–ª. –ö–∞—Ä—Ç—ã, –∫–∞—Ä—Ç—ã, –∫–∞—Ä—Ç—ã!"
        ]
        await update.message.reply_text(random.choice(replies))

# ====== –°–û–ó–î–ê–Å–ú –ü–†–ò–õ–û–ñ–ï–ù–ò–ï ======
application = ApplicationBuilder().token(TOKEN).build()
application.add_handler(CommandHandler("start", start))
application.add_handler(CommandHandler("tarot", tarot))
application.add_handler(CommandHandler("spread", spread))
application.add_handler(CommandHandler("whisper", whisper))  # –ù–æ–≤–∞—è –∫–æ–º–∞–Ω–¥–∞
application.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, unknown))

# ====== –ó–ê–ü–£–°–ö ======
if __name__ == "__main__":
    port = int(os.environ.get('PORT', 10000))
    render_url = os.environ.get('RENDER_EXTERNAL_URL', '')

    if render_url:
        webhook_url = f"{render_url}/webhook"
        print(f"‚ú® –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é –≤–µ–±-—Ö—É–∫ –Ω–∞ {webhook_url}")
        application.run_webhook(
            listen="0.0.0.0",
            port=port,
            url_path="webhook",
            webhook_url=webhook_url
        )
    else:
        print("‚ö†Ô∏è RENDER_EXTERNAL_URL –Ω–µ –∑–∞–¥–∞–Ω, –∑–∞–ø—É—Å–∫–∞—é polling (–¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ç–µ—Å—Ç–∞)")
        application.run_polling()
